<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>EyeNote Legacy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background:#f6f7fb; margin:0; }
    .wrap { max-width: 900px; margin: 10px auto 28px; padding: 10px; }
    .card { background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:12px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    h2 { font-size: 16px; margin: 0 0 10px; }
    label { display:block; font-size:13px; color:#374151; margin:8px 0 6px; }
    input[type="text"], select { width:100%; padding:9px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; box-sizing: border-box; }
    input[type="file"] { width:100%; }
    .row { display:flex; flex-wrap:wrap; gap:10px; }
    .col { flex: 1 1 260px; min-width: 200px; }
    .col-narrow { flex: 0 0 240px; min-width: 220px; }
    .col-auto { flex: 0 0 auto; }
    .btn { display:inline-block; background:#2563eb; color:#fff; border:none; padding:9px 13px; border-radius:8px; font-weight:600; font-size:14px; cursor:pointer; }
    .btn.gray { background:#6b7280; }
    .btn.red { background:#dc2626; }
    .btn.ghost { background:transparent; color:#374151; border:1px solid #e5e7eb; }
    .btn:disabled { background:#9ca3af; cursor:not-allowed; }
    .muted { color:#6b7280; font-size:12px; margin-top:6px;}
    .ok { color:#16a34a; font-size:13px; margin-top:8px;}
    .err { color:#dc2626; font-size:13px; margin-top:8px;}
    .sep { height:1px; background:#e5e7eb; margin:12px 0; }

    .doctor-list { display:flex; flex-wrap:wrap; gap:8px; }
    .doctor-item { display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb; }
    .doctor-item .name { font-weight:600; }
    .doctor-item .docid { font-size:12px; color:#6b7280; }
    .doctor-item.selected { background:#e0f2fe; border-color:#93c5fd; }

    .patients { max-height: 340px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
    .patient-row { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid #f1f5f9; }
    .patient-row:last-child { border-bottom:none; }
    .p-title { font-size:14px; font-weight:600; }
    .p-sub { font-size:12px; color:#6b7280; }

    .toggler { display:inline-flex; align-items:center; gap:6px; }
    .toggler .caret { transition: transform .15s linear; }
    .toggler[aria-expanded="true"] .caret { transform: rotate(90deg); }

    /* ===== Barra de transmiss√£o (vermelha) ===== */
    .broadcast {
      display: none;
      color: #fff;
      background: #ef4444; /* vermelho */
      padding: 10px 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .5px;
      text-align: left;
      border: 2px solid #b91c1c;
      border-radius: 8px;
      margin: 10px 0 12px 0; /* entre t√≠tulo e box M√©dicos */
    }
    .broadcast.pulse { animation: pulseFlash 2.5s linear infinite; } /* mais suave */
    @keyframes pulseFlash { 0%,100%{filter:brightness(1);} 50%{filter:brightness(1.25);} }
    .broadcast .topline { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .broadcast .msg { display:block; margin-top:6px; }
    .broadcast .mini { background:#fff; color:#b91c1c; border:1px solid #fecaca; font-weight:700; padding:6px 8px; border-radius:8px; }

    /* ====== LISTA DE AVISOS (m√∫ltiplos) ‚Äî ESCOPADA ====== */
    .legacy-alerts { margin: 12px 0; }
    .legacy-alerts.hidden { display: none; }
    .legacy-alerts-item {
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
      /* Sem anima√ß√£o aqui para evitar ‚Äúpiscadas‚Äù excessivas */
    }
    .legacy-alerts-title { font-weight:700; margin-bottom:4px; }
    .legacy-alerts-line { font-size:14px; }
    .legacy-alerts-line b { font-weight:700; }
    .legacy-alerts-actions { margin-top:6px; }
    .legacy-alerts-btn {
      background:#ef4444; color:#fff; border:none; border-radius:6px; padding:6px 10px; font-size:12px; cursor:pointer;
    }
  </style>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>EyeNote ‚Äì Uploader Legacy</h1>

      <!-- Lista de avisos (m√∫ltiplos) -->
      <div id="legacy-alerts-root" class="legacy-alerts hidden"></div>

      <!-- Barra de transmiss√£o abaixo do t√≠tulo -->
      <div id="broadcastBar" class="broadcast">
        <div class="topline">
          <div id="broadcastMeta">‚Äî</div>
          <button id="btnBroadcastOff" class="mini" title="Desativar alerta para todos">Desativar alerta</button>
        </div>
        <div id="broadcastMsg" class="msg"></div>
      </div>

      <div id="status" class="muted">Carregando...</div>
      <div id="app" style="display:none">

        <!-- ===== M√©dicos ===== -->
        <div class="card">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <h2 style="margin:0;">M√©dicos</h2>
            <div class="row col-auto" style="gap:8px;">
              <button class="btn ghost toggler" id="btnToggleAdd" aria-expanded="false" title="Cadastrar/editar m√©dicos">
                <span class="caret">‚ñ∂</span> Cadastrar m√©dico
              </button>
              <button class="btn ghost" id="btnRemoveSelected" title="Remover m√©dico selecionado">Remover selecionado</button>
            </div>
          </div>

          <div id="addDoctorBox" style="display:none; margin-top:8px;">
            <div class="row">
              <div class="col">
                <label>Nome do m√©dico</label>
                <input type="text" id="doctorName" placeholder="Ex.: Dr. Jo√£o">
              </div>
              <div class="col-narrow">
                <label>ID do documento</label>
                <input type="text" id="doctorDocId" placeholder="Ex.: abc123">
              </div>
              <div class="col-auto" style="align-self:flex-end;">
                <button class="btn" id="btnAddDoctor">Adicionar</button>
              </div>
            </div>
            <div class="sep"></div>
          </div>

          <label>Escolha o m√©dico para enviar</label>
          <div class="doctor-list" id="doctorList"></div>
          <div class="muted" id="noDoctorsNote" style="display:none;">Nenhum m√©dico cadastrado.</div>
        </div>

        <!-- ===== Novo Paciente / Exames ===== -->
        <div class="card">
          <h2>Novo Paciente / Exames</h2>
          <div class="row">
            <div class="col">
              <label>Paciente (nome)</label>
              <input type="text" id="patientName" placeholder="Ex.: Maria Silva">
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>AR (imagem)</label>
              <input type="file" id="arFile" accept="image/*">
            </div>
            <div class="col">
              <label>Tonometria (imagem)</label>
              <input type="file" id="tonoFile" accept="image/*">
            </div>
          </div>

          <div class="sep"></div>
          <div class="row">
            <button id="btnCreate" class="btn">Criar/Enviar</button>
            <button id="btnReset" class="btn gray">Limpar</button>
          </div>
          <div id="msgOk" class="ok" style="display:none"></div>
          <div id="msgErr" class="err" style="display:none"></div>
        </div>

        <!-- ===== Pacientes ===== -->
        <div class="card">
          <h2>Pacientes do M√©dico Selecionado</h2>
          <div class="patients" id="patientsBox"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bot√£o ‚ÄúAtivar som‚Äù (uma vez por abertura) -->
  <div class="sound-pill">
    <button id="soundBtn" class="pill" title="Toque para habilitar √°udio">üîä Ativar som</button>
  </div>

<script>
(function(){
  function $(id){ return document.getElementById(id); }
  function clean(s){ return String(s || '').replace(/\s+/g,' ').trim(); }
  function show(el, on){ el.style.display = on ? 'block' : 'none'; }
  function fmtDate(ts){
    try{
      if (!ts) return '';
      if (ts.toDate) return ts.toDate().toLocaleString();
      return new Date(ts).toLocaleString();
    }catch(e){ return ''; }
  }

  var statusEl = $('status'), appEl = $('app');
  var okEl = $('msgOk'), errEl = $('msgErr');

  var doctorNameInput = $('doctorName');
  var doctorDocIdInput = $('doctorDocId');
  var doctorListEl = $('doctorList');
  var noDoctorsNoteEl = $('noDoctorsNote');
  var btnRemoveSelected = $('btnRemoveSelected');
  var btnToggleAdd = $('btnToggleAdd');
  var addDoctorBox = $('addDoctorBox');

  var patientNameInput = $('patientName');
  var arInput = $('arFile'), tonoInput = $('tonoFile');
  var btnCreate = $('btnCreate'), btnReset = $('btnReset');

  var patientsBox = $('patientsBox');

  var broadcastBar = $('broadcastBar');
  var broadcastMsg = $('broadcastMsg');
  var broadcastMeta = $('broadcastMeta');
  var btnBroadcastOff = $('btnBroadcastOff');

  var legacyAlertsRoot = $('legacy-alerts-root');

  var soundBtn = $('soundBtn');
  var audioCtx = null;
  var soundEnabled = false;

  var LS_DOCTORS = 'legacy_doctors_v1';
  var LS_SELECTED = 'legacy_selected_doctor_v1';

  var doctors = [];
  var selectedDoctor = null;
  var unsubscribePatients = null;
  var unsubscribeBroadcast = null;
  var legacyAlertsUnsub = null;
  var alertTimer = null;

  btnToggleAdd.onclick = function(){
    var open = addDoctorBox.style.display === 'block';
    addDoctorBox.style.display = open ? 'none' : 'block';
    btnToggleAdd.setAttribute('aria-expanded', open ? 'false' : 'true');
  };

  soundBtn.onclick = function(){
    try {
      if (!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') { audioCtx.resume(); }
      playBeep(200);
      soundEnabled = true;
      soundBtn.className = 'pill on';
      soundBtn.textContent = 'üîä Som ativado';
    } catch(e){
      alert('Falha ao ativar som: ' + (e.message || e));
    }
  };

  function playBeep(ms){
    if (!soundEnabled || !audioCtx) return;
    try {
      var dur = (ms || 300) / 1000;
      var osc = audioCtx.createOscillator();
      var gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.6, audioCtx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + dur + 0.02);
    } catch(e){}
  }

  function loadJSON(url, cb){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function(){
      if (xhr.readyState === 4){
        if (xhr.status >= 200 && xhr.status < 300){
          try { cb(null, JSON.parse(xhr.responseText)); }
          catch(e){ cb(e); }
        } else { cb(new Error('HTTP '+xhr.status)); }
      }
    };
    xhr.send();
  }

  function setBusy(on){ btnCreate.disabled = !!on; btnReset.disabled  = !!on; }
  function showErr(msg){ show(errEl, true); errEl.textContent = msg; show(okEl, false); }
  function showOk(msg){ show(okEl, true); okEl.textContent = msg; show(errEl, false); }

  function saveDoctors(){ try { localStorage.setItem(LS_DOCTORS, JSON.stringify(doctors)); } catch(e){} }
  function loadDoctors(){ try { var s = localStorage.getItem(LS_DOCTORS); if (s){ doctors = JSON.parse(s) || []; } } catch(e){ doctors = []; } }
  function saveSelectedDoctor(){ try { localStorage.setItem(LS_SELECTED, JSON.stringify(selectedDoctor || null)); } catch(e){} }
  function loadSelectedDoctor(){ try { var s = localStorage.getItem(LS_SELECTED); if (s) selectedDoctor = JSON.parse(s) || null; } catch(e){ selectedDoctor = null; } }

  btnBroadcastOff.onclick = function(){
    if (!selectedDoctor || !selectedDoctor.docId) return;
    firebase.firestore().collection('broadcasts').doc(selectedDoctor.docId).set(
      { active:false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
      { merge:true }
    ).catch(function(e){
      alert('Falha ao desativar: ' + (e.message || e));
    });
  };

  function resetBroadcastUI(){
    broadcastBar.className = 'broadcast';
    broadcastMsg.textContent = '';
    broadcastMeta.textContent = '';
    broadcastBar.style.display = 'none';
    if (alertTimer){ clearInterval(alertTimer); alertTimer = null; }
  }

  function subscribeBroadcast(){
    if (unsubscribeBroadcast){ try{ unsubscribeBroadcast(); }catch(e){} unsubscribeBroadcast = null; }
    if (alertTimer){ clearInterval(alertTimer); alertTimer = null; }
    if (!selectedDoctor || !selectedDoctor.docId){ resetBroadcastUI(); return; }

    var ref = firebase.firestore().collection('broadcasts').doc(selectedDoctor.docId);
    unsubscribeBroadcast = ref.onSnapshot(function(doc){
      var data = doc.exists ? doc.data() : null;
      if (data && data.active && data.message){
        var emitterName = (data.emittedByName && String(data.emittedByName)) || (selectedDoctor ? selectedDoctor.name : '‚Äî');
        var emitterDoc  = (data.emittedByDocId && String(data.emittedByDocId)) || (selectedDoctor ? selectedDoctor.docId : '‚Äî');

        broadcastMeta.textContent = 'Alerta de: ' + emitterName + ' (' + emitterDoc + ')';
        broadcastMsg.textContent = data.message;

        broadcastBar.style.display = 'block';
        broadcastBar.className = 'broadcast pulse';

        playBeep(280);
        if (alertTimer){ clearInterval(alertTimer); }
        alertTimer = setInterval(function(){ playBeep(280); }, 10000);
      } else {
        resetBroadcastUI();
      }
    }, function(err){ console.log('Broadcast error', err); });
  }

  /* ====== AVISOS M√öLTIPLOS (subcole√ß√£o) ====== */

  function resetLegacyAlertsUI(){
    if (!legacyAlertsRoot) return;
    legacyAlertsRoot.innerHTML = '';
    legacyAlertsRoot.className = 'legacy-alerts hidden';
  }

  function renderLegacyAlerts(snapshot){
    if (!legacyAlertsRoot) return;
    legacyAlertsRoot.innerHTML = '';

    // Coleta e filtra no cliente + DEDUPE por (docId + paciente + msg + m√©dico)
    var seen = {};
    var items = [];
    snapshot.forEach(function(docSnap){
      var data = docSnap.data() || {};
      if (!data || !data.active) return;

      var medico = data.emittedByName || 'M√©dico';
      var paciente = data.patientName || data.patient || data.name || 'Paciente';
      var msg = (data.message || '').toUpperCase();

      var key = (selectedDoctor ? selectedDoctor.docId : '‚Äî') + '|' + medico + '|' + paciente + '|' + msg;
      if (seen[key]) return;
      seen[key] = true;

      items.push({ id: docSnap.id, data: data, ref: docSnap.ref });
    });

    if (!items.length){
      legacyAlertsRoot.className = 'legacy-alerts hidden';
      return;
    }

    legacyAlertsRoot.className = 'legacy-alerts';

    for (var i=0;i<items.length;i++){
      (function(idx){
        var d = items[idx].data;
        var ref = items[idx].ref;

        var medico = d.emittedByName || 'M√©dico';
        var paciente = d.patientName || d.patient || d.name || 'Paciente';
        var msg = (d.message || '').toUpperCase();

        var title = document.createElement('div');
        title.className = 'legacy-alerts-title';
        title.appendChild(document.createTextNode('<' + medico + ':>'));

        var line = document.createElement('div');
        line.className = 'legacy-alerts-line';

        var bPatient = document.createElement('b');
        bPatient.appendChild(document.createTextNode('Paciente ' + paciente));
        line.appendChild(bPatient);
        line.appendChild(document.createTextNode(': '));

        var bMsg = document.createElement('b');
        bMsg.appendChild(document.createTextNode(msg));
        line.appendChild(bMsg);

        var actions = document.createElement('div');
        actions.className = 'legacy-alerts-actions';
        var btn = document.createElement('button');
        btn.className = 'legacy-alerts-btn';
        btn.appendChild(document.createTextNode('Desativar'));
        btn.onclick = function(){
          ref.set({ active:false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
        };
        actions.appendChild(btn);

        var item = document.createElement('div');
        item.className = 'legacy-alerts-item';
        item.appendChild(title);
        item.appendChild(line);
        item.appendChild(actions);

        legacyAlertsRoot.appendChild(item);
      })(i);
    }
  }

  var legacyAlertsUnsub = null;
  function subscribeLegacyAlerts(){
    if (legacyAlertsUnsub){ try{ legacyAlertsUnsub(); }catch(e){} legacyAlertsUnsub = null; }
    resetLegacyAlertsUI();
    if (!selectedDoctor || !selectedDoctor.docId) return;

    var ref = firebase.firestore()
      .collection('broadcasts').doc(selectedDoctor.docId)
      .collection('alerts')
      .orderBy('createdAt','desc')
      .limit(30);

    legacyAlertsUnsub = ref.onSnapshot(function(snap){
      renderLegacyAlerts(snap);
    }, function(err){
      console.log('Alerts listener error:', err);
    });
  }

  function unsubscribeLegacyAlerts(){
    if (legacyAlertsUnsub){ try{ legacyAlertsUnsub(); }catch(e){} legacyAlertsUnsub = null; }
    resetLegacyAlertsUI();
  }

  /* ====== Pacientes ====== */

  function subscribePatientsForSelected(){
    if (unsubscribePatients){ try{ unsubscribePatients(); }catch(e){} unsubscribePatients = null; }
    if (!selectedDoctor || !selectedDoctor.docId){
      renderPatients([]);
      return;
    }
    var q = firebase.firestore()
      .collection('patients')
      .where('documentId','==', selectedDoctor.docId)
      .where('status','==','active');

    unsubscribePatients = q.onSnapshot(function(snap){
      var arr = [];
      for (var i=0;i<snap.docs.length;i++){
        var d = snap.docs[i];
        var data = d.data() || {};
        data.id = d.id;
        arr.push(data);
      }
      arr.sort(function(a,b){
        var ta = (a.createdAt && a.createdAt.toMillis) ? a.createdAt.toMillis() : 0;
        var tb = (b.createdAt && b.createdAt.toMillis) ? b.createdAt.toMillis() : 0;
        return tb - ta;
      });
      renderPatients(arr);
    }, function(err){
      console.log('Erro ao listar pacientes:', err);
      renderPatients([]);
    });
  }

  function renderPatients(list){
    patientsBox.innerHTML = '';
    if (!list.length){
      var empty = document.createElement('div');
      empty.className = 'patient-row';
      empty.innerHTML = '<div class="p-sub">Nenhum paciente para este m√©dico.</div>';
      patientsBox.appendChild(empty);
      return;
    }
    for (var i=0;i<list.length;i++){
      (function(idx){
        var p = list[idx];
        var row = document.createElement('div');
        row.className = 'patient-row';

        var left = document.createElement('div');
        var title = document.createElement('div');
        title.className = 'p-title';
        title.textContent = p.name || 'Sem nome';
        var sub = document.createElement('div');
        sub.className = 'p-sub';
        sub.textContent = 'ID: ' + (p.id || '‚Äî') + ' ‚Ä¢ Criado: ' + fmtDate(p.createdAt);

        left.appendChild(title);
        left.appendChild(sub);

        var right = document.createElement('div');
        var btnA = document.createElement('button');
        btnA.className = 'btn red';
        btnA.textContent = 'Arquivar';
        btnA.onclick = function(){
          if (!p.id) return;
          firebase.firestore().collection('patients').doc(p.id).set(
            { status: 'archived' },
            { merge: true }
          ).catch(function(e){
            alert('Falha ao arquivar: ' + (e.message || e));
          });
        };

        right.appendChild(btnA);

        row.appendChild(left);
        row.appendChild(right);
        patientsBox.appendChild(row);
      })(i);
    }
  }

  function renderDoctors(){
    doctorListEl.innerHTML = '';
    if (!doctors.length){
      show(noDoctorsNoteEl, true);
      selectedDoctor = null;
      saveSelectedDoctor();
      renderPatients([]);
      subscribeBroadcast();
      unsubscribeLegacyAlerts();
      return;
    }
    show(noDoctorsNoteEl, false);
    for (var i=0;i<doctors.length;i++){
      (function(idx){
        var d = doctors[idx];
        var wrap = document.createElement('label');
        wrap.className = 'doctor-item';
        var isSelected = (selectedDoctor && selectedDoctor.docId === d.docId);
        if (isSelected){ wrap.className += ' selected'; }

        var radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'doctorPick';
        radio.checked = isSelected;
        radio.onchange = function(){
          selectedDoctor = { name: d.name, docId: d.docId };
          saveSelectedDoctor();
          renderDoctors();
          subscribePatientsForSelected();
          subscribeBroadcast();
          subscribeLegacyAlerts();
        };

        var nm = document.createElement('span');
        nm.className = 'name';
        nm.textContent = d.name;
        var dd = document.createElement('span');
        dd.className = 'docid';
        dd.textContent = d.docId;

        wrap.appendChild(radio);
        wrap.appendChild(nm);
        wrap.appendChild(dd);
        doctorListEl.appendChild(wrap);
      })(i);
    }
    if (!selectedDoctor && doctors.length){
      selectedDoctor = { name: doctors[0].name, docId: doctors[0].docId };
      saveSelectedDoctor();
    }
    subscribePatientsForSelected();
    subscribeBroadcast();
    subscribeLegacyAlerts();
  }

  function uploadIfAny(file, patientId, kind, cb){
    if (!file){ cb(null, null); return; }
    try {
      var ext = '.jpg';
      var mime = file.type || 'image/jpeg';
      if (mime.indexOf('png') >= 0) ext = '.png';
      var path = 'exams/'+ patientId + '/' + kind + '_' + Date.now() + ext;
      var ref = firebase.storage().ref().child(path);
      var task = ref.put(file, { contentType: mime });
      task.on('state_changed',
        function(){},
        function(err){ cb(err); },
        function(){
          ref.getDownloadURL().then(function(url){
            cb(null, { url: url, path: path });
          }).catch(function(e){ cb(e); });
        }
      );
    } catch(e){
      cb(e);
    }
  }

  $('btnAddDoctor').onclick = function(){
    var nm = clean(doctorNameInput ? doctorNameInput.value : '');
    var id = clean(doctorDocIdInput ? doctorDocIdInput.value : '');
    if (!nm || !id){ return; }

    var exists = false;
    for (var i=0;i<doctors.length;i++){ if (doctors[i].docId === id){ exists = true; break; } }
    if (!exists){
      doctors.push({ name: nm, docId: id });
      saveDoctors();
      renderDoctors();
    }
    if (doctorNameInput) doctorNameInput.value = '';
    if (doctorDocIdInput) doctorDocIdInput.value = '';
  };

  btnRemoveSelected.onclick = function(){
    if (!selectedDoctor || !selectedDoctor.docId) return;
    var target = selectedDoctor.docId;
    var next = [];
    for (var i=0;i<doctors.length;i++){
      if (doctors[i].docId !== target){ next.push(doctors[i]); }
    }
    doctors = next;
    selectedDoctor = null;
    saveDoctors();
    saveSelectedDoctor();
    renderDoctors();
  };

  btnCreate.onclick = function(){
    show(okEl, false); show(errEl, false);
    if (!selectedDoctor || !selectedDoctor.docId){ showErr('Selecione um m√©dico.'); return; }
    var name  = clean(patientNameInput.value);
    var arF   = arInput.files[0] || null;
    var toF   = tonoInput.files[0] || null;
    if (!name){ showErr('Informe o nome do paciente.'); return; }

    setBusy(true);
    var patientId = 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);

    uploadIfAny(arF, patientId, 'ar', function(err1, arRes){
      if (err1){ setBusy(false); showErr('Falha no upload AR: '+ (err1.message || err1)); return; }

      uploadIfAny(toF, patientId, 'tonometry', function(err2, toRes){
        if (err2){ setBusy(false); showErr('Falha no upload Tonometria: '+ (err2.message || err2)); return; }

        var exams = {};
        if (arRes){ exams.ar = { uploaded: true, url: arRes.url, uploadedAt: firebase.firestore.FieldValue.serverTimestamp() }; }
        if (toRes){ exams.tonometry = { uploaded: true, url: toRes.url, uploadedAt: firebase.firestore.FieldValue.serverTimestamp() }; }

        var data = {
          id: patientId, name: name, status: 'active',
          documentId: selectedDoctor.docId,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (Object.keys(exams).length > 0){ data.exams = exams; }

        firebase.firestore().collection('patients').doc(patientId).set(data, { merge: true })
          .then(function(){ showOk('Paciente criado/enviado.'); patientNameInput.value=''; arInput.value=''; tonoInput.value=''; })
          .catch(function(e){ showErr('Erro ao salvar paciente: ' + (e.message || e)); })
          .finally(function(){ setBusy(false); });
      });
    });
  };

  btnReset.onclick = function(){ patientNameInput.value=''; arInput.value=''; tonoInput.value=''; show(okEl,false); show(errEl,false); };

  loadJSON('/firebase-config.json', function(err, cfg){
    if (err){ statusEl.textContent = 'Erro ao carregar firebase-config.json'; return; }
    try { firebase.initializeApp(cfg); } catch(e){ statusEl.textContent = 'Falha ao inicializar Firebase.'; return; }

    firebase.auth().onAuthStateChanged(function(user){
      if (user){
        statusEl.style.display='none'; appEl.style.display='block';
        addDoctorBox.style.display='none'; btnToggleAdd.setAttribute('aria-expanded','false');

        soundBtn.className = 'pill'; soundBtn.textContent = 'üîä Ativar som';

        loadDoctors(); loadSelectedDoctor(); renderDoctors();
      } else { statusEl.textContent = 'Conectando...'; }
    }, function(e){ statusEl.textContent='Falha na autentica√ß√£o.'; console.log(e); });

    firebase.auth().signInAnonymously().catch(function(e){ console.log('Auth anon:', e); });
  });
})();
</script>
</body>
</html>
