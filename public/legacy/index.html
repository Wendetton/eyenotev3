<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>EyeNote Legacy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background:#f6f7fb; margin:0; }
    .wrap { max-width: 900px; margin: 10px auto 28px; padding: 10px; }
    .card { background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:12px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    h2 { font-size: 16px; margin: 0 0 10px; }
    label { display:block; font-size:13px; color:#374151; margin:8px 0 6px; }
    input[type="text"], select { width:100%; padding:9px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; }
    input[type="file"] { width:100%; }
    .row { display:flex; gap:10px; }
    .col { flex:1; }
    .btn { display:inline-block; background:#2563eb; color:#fff; border:none; padding:9px 13px; border-radius:8px; font-weight:600; font-size:14px; }
    .btn.gray { background:#6b7280; }
    .btn.red { background:#dc2626; }
    .btn:disabled { background:#9ca3af; }
    .muted { color:#6b7280; font-size:12px; margin-top:6px;}
    .ok { color:#16a34a; font-size:13px; margin-top:8px;}
    .err { color:#dc2626; font-size:13px; margin-top:8px;}
    .sep { height:1px; background:#e5e7eb; margin:12px 0; }

    .doctor-list { display:flex; flex-wrap:wrap; gap:8px; }
    .doctor-item { display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb; }
    .doctor-item .name { font-weight:600; }
    .doctor-item .docid { font-size:12px; color:#6b7280; }
    .doctor-actions { display:flex; gap:6px; margin-top:8px; }

    .patients { max-height: 340px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
    .patient-row { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid #f1f5f9; }
    .patient-row:last-child { border-bottom:none; }
    .p-title { font-size:14px; font-weight:600; }
    .p-sub { font-size:12px; color:#6b7280; }
  </style>

  <!-- Firebase v8 (compatível iOS 10) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>EyeNote – Uploader Legacy</h1>
      <div id="status" class="muted">Carregando...</div>
      <div id="app" style="display:none">

        <!-- ====== Médicos (docIds) ====== -->
        <div class="card">
          <h2>Médicos</h2>
          <div class="row">
            <div class="col">
              <label>Nome do médico</label>
              <input type="text" id="doctorName" placeholder="Ex.: Dr. João">
            </div>
            <div class="col">
              <label>ID do documento</label>
              <input type="text" id="doctorDocId" placeholder="Ex.: abc123">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnAddDoctor">Adicionar</button>
            </div>
          </div>

          <div class="sep"></div>

          <label>Escolha o médico para enviar</label>
          <div class="doctor-list" id="doctorList"></div>
          <div class="muted" id="noDoctorsNote" style="display:none;">Nenhum médico cadastrado.</div>
        </div>

        <!-- ====== Criar paciente / Upload ====== -->
        <div class="card">
          <h2>Novo Paciente / Exames</h2>
          <div class="row">
            <div class="col">
              <label>Paciente (nome)</label>
              <input type="text" id="patientName" placeholder="Ex.: Maria Silva">
            </div>
            <div class="col">
              <label>Médico (selecionado acima)</label>
              <input type="text" id="selectedDoctorBadge" disabled>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>AR (imagem)</label>
              <input type="file" id="arFile" accept="image/*">
            </div>
            <div class="col">
              <label>Tonometria (imagem)</label>
              <input type="file" id="tonoFile" accept="image/*">
            </div>
          </div>

          <div class="sep"></div>
          <div class="row">
            <button id="btnCreate" class="btn">Criar/Enviar</button>
            <button id="btnReset" class="btn gray">Limpar</button>
          </div>
          <div id="msgOk" class="ok" style="display:none"></div>
          <div id="msgErr" class="err" style="display:none"></div>
        </div>

        <!-- ====== Pacientes do médico selecionado ====== -->
        <div class="card">
          <h2>Pacientes do Médico Selecionado</h2>
          <div class="patients" id="patientsBox">
            <!-- linhas aqui -->
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== Helpers gerais =====
  function $(id){ return document.getElementById(id); }
  function clean(s){ return String(s || '').replace(/\s+/g,' ').trim(); }
  function show(el, on){ el.style.display = on ? 'block' : 'none'; }
  function fmtDate(ts){
    try{
      if (!ts) return '';
      if (ts.toDate) return ts.toDate().toLocaleString();
      return new Date(ts).toLocaleString();
    }catch(e){ return ''; }
  }

  var statusEl = $('status');
  var appEl = $('app');
  var okEl = $('msgOk');
  var errEl = $('msgErr');

  var doctorNameInput = $('doctorName');
  var doctorDocIdInput = $('doctorDocId');
  var doctorListEl = $('doctorList');
  var noDoctorsNoteEl = $('noDoctorsNote');
  var selectedDoctorBadge = $('selectedDoctorBadge');

  var patientNameInput = $('patientName');
  var arInput = $('arFile');
  var tonoInput = $('tonoFile');
  var btnCreate = $('btnCreate');
  var btnReset  = $('btnReset');

  var patientsBox = $('patientsBox');

  var LS_DOCTORS = 'legacy_doctors_v1';
  var LS_SELECTED = 'legacy_selected_doctor_v1';

  var doctors = []; // [{name, docId}]
  var selectedDoctor = null; // {name, docId}

  // ===== Inicializa Firebase com config pública em /firebase-config.json =====
  function loadJSON(url, cb){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function(){
      if (xhr.readyState === 4){
        if (xhr.status >= 200 && xhr.status < 300){
          try { cb(null, JSON.parse(xhr.responseText)); }
          catch(e){ cb(e); }
        } else {
          cb(new Error('HTTP '+xhr.status));
        }
      }
    };
    xhr.send();
  }

  function setBusy(on){
    btnCreate.disabled = !!on;
    btnReset.disabled  = !!on;
  }
  function showErr(msg){
    show(errEl, true);
    errEl.textContent = msg;
    show(okEl, false);
  }
  function showOk(msg){
    show(okEl, true);
    okEl.textContent = msg;
    show(errEl, false);
  }

  function saveDoctors(){
    try { localStorage.setItem(LS_DOCTORS, JSON.stringify(doctors)); } catch(e){}
  }
  function loadDoctors(){
    try {
      var s = localStorage.getItem(LS_DOCTORS);
      if (s){ doctors = JSON.parse(s) || []; }
    } catch(e){ doctors = []; }
  }
  function saveSelectedDoctor(){
    try { localStorage.setItem(LS_SELECTED, JSON.stringify(selectedDoctor || null)); } catch(e){}
  }
  function loadSelectedDoctor(){
    try {
      var s = localStorage.getItem(LS_SELECTED);
      if (s) selectedDoctor = JSON.parse(s) || null;
    } catch(e){ selectedDoctor = null; }
  }

  function renderDoctors(){
    doctorListEl.innerHTML = '';
    if (!doctors.length){
      show(noDoctorsNoteEl, true);
      selectedDoctor = null;
      selectedDoctorBadge.value = '';
      saveSelectedDoctor();
      renderPatients([]);
      return;
    }
    show(noDoctorsNoteEl, false);
    for (var i=0;i<doctors.length;i++){
      (function(idx){
        var d = doctors[idx];
        var wrap = document.createElement('label');
        wrap.className = 'doctor-item';
        var radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'doctorPick';
        radio.checked = (selectedDoctor && selectedDoctor.docId === d.docId);
        radio.onchange = function(){
          selectedDoctor = { name: d.name, docId: d.docId };
          selectedDoctorBadge.value = d.name + ' (' + d.docId + ')';
          saveSelectedDoctor();
          subscribePatientsForSelected(); // recarrega lista
        };
        var nm = document.createElement('span');
        nm.className = 'name';
        nm.textContent = d.name;
        var dd = document.createElement('span');
        dd.className = 'docid';
        dd.textContent = d.docId;

        wrap.appendChild(radio);
        wrap.appendChild(nm);
        wrap.appendChild(dd);
        doctorListEl.appendChild(wrap);
      })(i);
    }
    // manter seleção válida
    if (!selectedDoctor && doctors.length){
      selectedDoctor = { name: doctors[0].name, docId: doctors[0].docId };
    }
    if (selectedDoctor){
      selectedDoctorBadge.value = selectedDoctor.name + ' (' + selectedDoctor.docId + ')';
      saveSelectedDoctor();
      subscribePatientsForSelected();
    }
  }

  // ====== Pacientes (lista + arquivar) ======
  var unsubscribePatients = null;
  function subscribePatientsForSelected(){
    if (unsubscribePatients){ try{ unsubscribePatients(); }catch(e){} unsubscribePatients = null; }
    if (!selectedDoctor || !selectedDoctor.docId){
      renderPatients([]);
      return;
    }
    // Duplo filtro por igualdade não precisa de índice; ordenamos no client.
    var q = firebase.firestore()
      .collection('patients')
      .where('documentId','==', selectedDoctor.docId)
      .where('status','==','active');

    unsubscribePatients = q.onSnapshot(function(snap){
      var arr = [];
      for (var i=0;i<snap.docs.length;i++){
        var d = snap.docs[i];
        var data = d.data() || {};
        data.id = d.id;
        arr.push(data);
      }
      // ordena por createdAt desc na mão
      arr.sort(function(a,b){
        var ta = (a.createdAt && a.createdAt.toMillis) ? a.createdAt.toMillis() : 0;
        var tb = (b.createdAt && b.createdAt.toMillis) ? b.createdAt.toMillis() : 0;
        return tb - ta;
      });
      renderPatients(arr);
    }, function(err){
      console.log('Erro ao listar pacientes:', err);
      renderPatients([]);
    });
  }

  function renderPatients(list){
    patientsBox.innerHTML = '';
    if (!list.length){
      var empty = document.createElement('div');
      empty.className = 'patient-row';
      empty.innerHTML = '<div class="p-sub">Nenhum paciente para este médico.</div>';
      patientsBox.appendChild(empty);
      return;
    }
    for (var i=0;i<list.length;i++){
      (function(idx){
        var p = list[idx];
        var row = document.createElement('div');
        row.className = 'patient-row';

        var left = document.createElement('div');
        var title = document.createElement('div');
        title.className = 'p-title';
        title.textContent = p.name || 'Sem nome';
        var sub = document.createElement('div');
        sub.className = 'p-sub';
        sub.textContent = 'ID: ' + (p.id || '—') + ' • Criado: ' + fmtDate(p.createdAt);

        left.appendChild(title);
        left.appendChild(sub);

        var right = document.createElement('div');
        var btnA = document.createElement('button');
        btnA.className = 'btn red';
        btnA.textContent = 'Arquivar';
        btnA.onclick = function(){
          if (!p.id) return;
          firebase.firestore().collection('patients').doc(p.id).set(
            { status: 'archived' },
            { merge: true }
          ).catch(function(e){
            alert('Falha ao arquivar: ' + (e.message || e));
          });
        };

        right.appendChild(btnA);

        row.appendChild(left);
        row.appendChild(right);
        patientsBox.appendChild(row);
      })(i);
    }
  }

  // ===== Upload de arquivos =====
  function uploadIfAny(file, patientId, kind, cb){
    if (!file){ cb(null, null); return; }
    try {
      var ext = '.jpg';
      var mime = file.type || 'image/jpeg';
      if (mime.indexOf('png') >= 0) ext = '.png';
      var path = 'exams/'+ patientId + '/' + kind + '_' + Date.now() + ext;
      var ref = firebase.storage().ref().child(path);
      var task = ref.put(file, { contentType: mime });
      task.on('state_changed',
        function(){},
        function(err){ cb(err); },
        function(){
          ref.getDownloadURL().then(function(url){
            cb(null, { url: url, path: path });
          }).catch(function(e){ cb(e); });
        }
      );
    } catch(e){
      cb(e);
    }
  }

  // ===== Fluxo principal =====
  $('btnAddDoctor').onclick = function(){
    var nm = clean(doctorNameInput.value);
    var id = clean(doctorDocIdInput.value);
    if (!nm || !id){ return; }
    // evita duplicados por docId
    var exists = false;
    for (var i=0;i<doctors.length;i++){ if (doctors[i].docId === id){ exists = true; break; } }
    if (!exists){
      doctors.push({ name: nm, docId: id });
      saveDoctors();
      renderDoctors();
    }
    doctorNameInput.value = '';
    doctorDocIdInput.value = '';
  };

  btnCreate.onclick = function(){
    show(okEl, false); show(errEl, false);

    if (!selectedDoctor || !selectedDoctor.docId){
      showErr('Selecione um médico.');
      return;
    }
    var name  = clean(patientNameInput.value);
    var arF   = arInput.files[0] || null;
    var toF   = tonoInput.files[0] || null;

    if (!name){ showErr('Informe o nome do paciente.'); return; }

    setBusy(true);

    var patientId = 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);

    uploadIfAny(arF,  patientId, 'ar', function(err1, arRes){
      if (err1){ setBusy(false); showErr('Falha no upload AR: '+ (err1.message || err1)); return; }

      uploadIfAny(toF, patientId, 'tonometry', function(err2, toRes){
        if (err2){ setBusy(false); showErr('Falha no upload Tonometria: '+ (err2.message || err2)); return; }

        var exams = {};
        if (arRes){
          exams.ar = {
            uploaded: true,
            url: arRes.url,
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
        }
        if (toRes){
          exams.tonometry = {
            uploaded: true,
            url: toRes.url,
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
        }

        var data = {
          id: patientId,
          name: name,
          status: 'active',
          documentId: selectedDoctor.docId,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (Object.keys(exams).length > 0){ data.exams = exams; }

        firebase.firestore().collection('patients').doc(patientId).set(data, { merge: true })
          .then(function(){
            showOk('Paciente criado/enviado.');
            patientNameInput.value = '';
            arInput.value = '';
            tonoInput.value = '';
          })
          .catch(function(e){
            showErr('Erro ao salvar paciente: ' + (e.message || e));
          })
          .finally(function(){
            setBusy(false);
          });
      });
    });
  };

  btnReset.onclick = function(){
    patientNameInput.value = '';
    arInput.value = '';
    tonoInput.value = '';
    show(okEl, false); show(errEl, false);
  };

  // ===== Boot: carrega config Firebase, autentica anônimo, carrega médicos do LS =====
  loadJSON('/firebase-config.json', function(err, cfg){
    if (err){ statusEl.textContent = 'Erro ao carregar firebase-config.json'; return; }
    try {
      firebase.initializeApp(cfg);
    } catch(e){ statusEl.textContent = 'Falha ao inicializar Firebase.'; return; }

    firebase.auth().onAuthStateChanged(function(user){
      if (user){
        statusEl.style.display = 'none';
        appEl.style.display = 'block';

        loadDoctors();
        loadSelectedDoctor();
        renderDoctors();
      } else {
        statusEl.textContent = 'Conectando...';
      }
    }, function(e){
      statusEl.textContent = 'Falha na autenticação.';
      console.log(e);
    });

    // tenta auth anon
    firebase.auth().signInAnonymously().catch(function(e){
      console.log('Auth anon:', e);
    });
  });
})();
</script>
</body>
</html>
