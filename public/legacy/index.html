<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>EyeNote – Uploader Legacy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb; --gray-300:#d1d5db;
      --gray-600:#4b5563; --gray-700:#374151; --gray-900:#111827;
      --blue-600:#2563eb; --blue-700:#1d4ed8;
      --emerald-600:#059669; --yellow-600:#ca8a04;
      --red-50:#fef2f2; --red-100:#fee2e2; --red-300:#fca5a5; --red-600:#dc2626; --red-700:#b91c1c;
      --orange-500:#f97316;
      --indigo-600:#4f46e5;
      --radius:12px;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f5f7fb;color:#111;}
    .container{max-width:1080px;margin:28px auto;padding:0 16px;}
    h1{font-size:28px;margin:0 0 14px 0}
    .card{background:#fff;border:1px solid var(--gray-200);border-radius:var(--radius);padding:18px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .row-right{margin-left:auto}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:8px;border:1px solid transparent;
         padding:8px 14px;font-weight:600;cursor:pointer;user-select:none}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--blue-600);color:#fff}
    .btn-primary:hover{background:var(--blue-700)}
    .btn-danger{background:#fff;color:var(--red-700);border-color:var(--red-300)}
    .btn-danger:hover{background:var(--red-50)}
    .btn-outline{background:#fff;border-color:var(--gray-300);color:var(--gray-700)}
    .btn-outline:hover{background:var(--gray-50)}
    .input{width:100%;padding:10px 12px;border:1px solid var(--gray-300);border-radius:10px;outline:none}
    .section-title{font-size:18px;font-weight:700;margin:0 0 10px 0}
    .muted{color:var(--gray-600);font-size:13px}
    .pill{display:inline-flex;align-items:center;border:1px solid var(--gray-300);padding:6px 10px;border-radius:999px;gap:8px}
    .pill[data-selected="true"]{border-color:var(--indigo-600);box-shadow:0 0 0 2px rgba(79,70,229,.15)}
    .blink{animation:blink 1.2s linear infinite}
    @keyframes blink{0%,60%{opacity:1} 70%{opacity:.55} 80%{opacity:1} 90%{opacity:.55} 100%{opacity:1}}
    .alert-banner{
      background:var(--red-600); color:#fff; border-radius:var(--radius); padding:16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .alert-lines{line-height:1.1}
    .alert-lines .small{opacity:.95;font-size:13px}
    .alert-cards{margin-top:12px}
    .alert-card{
      background:var(--red-50); border:1px solid var(--red-300); color:#7f1d1d;
      border-radius:var(--radius); padding:12px; font-weight:600;
    }
    .strong{font-weight:800}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
    details summary{cursor:pointer;list-style:none}
    details summary::-webkit-details-marker{display:none}
    .caret::before{content:'▸';display:inline-block;margin-right:6px;transform:translateY(-1px)}
    details[open] .caret::before{content:'▾'}
  </style>
</head>
<body>
  <div class="container">

    <h1>EyeNote – Uploader Legacy</h1>

    <!-- BARRA DE ALERTA (pisca) -->
    <div id="alert-root" style="margin-bottom:12px; display:none;">
      <div class="alert-banner blink">
        <div class="alert-lines" id="alert-root-text">
          <!-- preenche via JS -->
        </div>
        <button id="btnDeactivate" class="btn btn-danger">Desativar alerta</button>
      </div>
      <div id="alert-list" class="alert-cards"><!-- itens simultâneos aparecem aqui --></div>
    </div>

    <!-- MÉDICOS -->
    <div class="card" style="margin-top:12px">
      <div class="row">
        <div class="section-title">Médicos</div>
        <div class="row-right">
          <button id="btnRemoveSelected" class="btn btn-outline">Remover selecionado</button>
        </div>
      </div>

      <details id="doctorAddBox" style="margin-top:10px">
        <summary class="pill caret">Cadastrar médico</summary>
        <div class="grid" style="margin-top:10px">
          <div>
            <label class="muted">Nome do médico</label>
            <input id="inpDocName" class="input" placeholder="Ex.: Dr. João"/>
          </div>
          <div>
            <label class="muted">ID do documento</label>
            <input id="inpDocId" class="input" placeholder="Ex.: xqw91md52y" style="max-width:280px"/>
          </div>
        </div>
        <div style="margin-top:10px">
          <button id="btnAddDoctor" class="btn btn-primary">Adicionar</button>
        </div>
      </details>

      <div style="margin-top:12px" class="muted">Escolha o médico para enviar</div>
      <div id="doctorList" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px"></div>
    </div>

    <!-- NOVO PACIENTE / EXAMES -->
    <div class="card" style="margin-top:14px">
      <div class="section-title">Novo Paciente / Exames</div>
      <div>
        <label class="muted">Paciente (nome)</label>
        <input id="inpPatientName" class="input" placeholder="Ex.: Maria Silva"/>
      </div>
      <div class="grid" style="margin-top:10px">
        <div>
          <label class="muted">AR (imagem)</label>
          <input id="fileAr" type="file" accept="image/*" />
        </div>
        <div>
          <label class="muted">Tonometria (imagem)</label>
          <input id="fileTono" type="file" accept="image/*" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnCreate" class="btn btn-primary">Criar/Enviar</button>
        <button id="btnClear" class="btn btn-outline">Limpar</button>
      </div>
    </div>

    <!-- PACIENTES DO MÉDICO SELECIONADO -->
    <div class="card" style="margin-top:14px">
      <div class="section-title">Pacientes do Médico Selecionado</div>
      <div id="patientsBox" class="muted">Nenhum paciente para este médico.</div>
    </div>

  </div>

  <!-- Firebase v8 (compat iOS10) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <script>
  (function(){
    var app = null, db = null, storage = null;
    var selectedDocId = null;
    var doctors = []; // {name,id}
    var rootUnsub = null, listUnsub = null;

    // --------- carregar config ----------
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/firebase-config.json', true);
    xhr.onreadystatechange = function(){
      if(xhr.readyState === 4){
        if(xhr.status >= 200 && xhr.status < 300){
          try {
            var cfg = JSON.parse(xhr.responseText);
            firebase.initializeApp(cfg);
            app = firebase.app();
            db = firebase.firestore();
            storage = firebase.storage();
            firebase.auth().signInAnonymously().catch(function(){});
            initUI();
            loadDoctors();
          } catch(e){ showToast('Erro ao iniciar Firebase'); }
        } else {
          showToast('Erro ao carregar firebase-config.json');
        }
      }
    };
    xhr.send(null);

    // --------- UI helpers ----------
    function $(id){ return document.getElementById(id); }
    function showToast(msg){ if(window.console) console.log(msg); }

    function saveDoctors(){
      try{ localStorage.setItem('legacy_doctors', JSON.stringify(doctors)); }catch(e){}
    }
    function loadDoctors(){
      try{
        var raw = localStorage.getItem('legacy_doctors');
        doctors = raw ? JSON.parse(raw) : [];
      }catch(e){ doctors = []; }
      renderDoctors();
      // selecionar o último usado
      var last = null; try{ last = localStorage.getItem('legacy_selected'); }catch(e){}
      if (last) selectDoctor(last);
    }

    function renderDoctors(){
      var box = $('doctorList');
      box.innerHTML = '';
      if (!doctors.length) { box.innerHTML = '<span class="muted">Nenhum médico cadastrado.</span>'; return; }
      for (var i=0;i<doctors.length;i++){
        (function(d){
          var pill = document.createElement('label');
          pill.className = 'pill';
          pill.setAttribute('data-selected', d.id === selectedDocId ? 'true' : 'false');

          var radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = 'doctor';
          radio.checked = (d.id === selectedDocId);
          radio.onchange = function(){ selectDoctor(d.id); };

          var dot = document.createElement('span');
          dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='999px';
          dot.style.background='#10b981'; dot.style.display='inline-block';

          var name = document.createElement('span');
          name.textContent = ' ' + d.name + ' ';
          var small = document.createElement('span');
          small.className = 'muted';
          small.textContent = d.id;

          pill.appendChild(radio); pill.appendChild(dot); pill.appendChild(name); pill.appendChild(small);
          box.appendChild(pill);
        })(doctors[i]);
      }
    }

    $('btnAddDoctor').onclick = function(){
      var name = $('inpDocName').value.replace(/^\s+|\s+$/g,'');
      var id   = $('inpDocId').value.replace(/^\s+|\s+$/g,'');
      if (!name || !id) { showToast('Preencha nome e id'); return; }
      doctors.push({name:name, id:id});
      saveDoctors();
      $('inpDocName').value=''; $('inpDocId').value='';
      renderDoctors();
      $('doctorAddBox').open = false;
    };

    $('btnRemoveSelected').onclick = function(){
      if (!selectedDocId) return;
      for (var i=0;i<doctors.length;i++){
        if (doctors[i].id === selectedDocId){ doctors.splice(i,1); break; }
      }
      saveDoctors();
      selectedDocId = null; try{ localStorage.removeItem('legacy_selected'); }catch(e){}
      detachBroadcastListeners();
      renderDoctors();
      renderAlertRoot(null); renderAlertList(null, []);
      $('patientsBox').innerHTML = 'Nenhum paciente para este médico.';
    };

    function selectDoctor(id){
      selectedDocId = id;
      try{ localStorage.setItem('legacy_selected', id); }catch(e){}
      renderDoctors();
      attachBroadcastListeners();
      loadPatientsForSelected();
    }

    // --------- Upload paciente ----------
    $('btnClear').onclick = function(){
      $('inpPatientName').value=''; $('fileAr').value=''; $('fileTono').value='';
    };

    $('btnCreate').onclick = function(){
      if (!selectedDocId){ alert('Selecione o médico.'); return; }
      var name = $('inpPatientName').value.replace(/^\s+|\s+$/g,'');
      if (!name){ alert('Digite o nome do paciente.'); return; }

      var arFile = $('fileAr').files[0] || null;
      var toFile = $('fileTono').files[0] || null;

      var pId = 'p_'+ Math.random().toString(36).slice(2);
      var payload = {
        id: pId,
        name: name,
        status: 'active',
        documentId: selectedDocId,
        createdAt: new Date(),
        exams: { ar: null, tonometry: null }
      };

      db.collection('patients').doc(pId).set(payload).then(function(){
        var uploads = [];
        if (arFile){
          var arRef = storage.ref().child('exams/'+pId+'/ar_'+Date.now()+'.jpg');
          uploads.push(arRef.put(arFile).then(function(){
            return arRef.getDownloadURL().then(function(url){
              return db.collection('patients').doc(pId).set({
                exams:{ ar:{ url:url, uploaded:true, uploadedAt:new Date() } }
              }, {merge:true});
            });
          }));
        }
        if (toFile){
          var tRef = storage.ref().child('exams/'+pId+'/tonometry_'+Date.now()+'.jpg');
          uploads.push(tRef.put(toFile).then(function(){
            return tRef.getDownloadURL().then(function(url){
              return db.collection('patients').doc(pId).set({
                exams:{ tonometry:{ url:url, uploaded:true, uploadedAt:new Date() } }
              }, {merge:true});
            });
          }));
        }
        return Promise.all(uploads);
      }).then(function(){
        $('btnClear').click();
        loadPatientsForSelected();
        alert('Enviado!');
      }).catch(function(e){
        console.error(e); alert('Falha no envio.');
      });
    };

    function loadPatientsForSelected(){
      if (!selectedDocId){ $('patientsBox').innerHTML = 'Nenhum paciente para este médico.'; return; }
      db.collection('patients').where('documentId','==',selectedDocId).where('status','==','active')
        .orderBy('createdAt','desc').limit(50).get().then(function(snap){
          if (snap.empty){ $('patientsBox').innerHTML = 'Nenhum paciente para este médico.'; return; }
          var frag = document.createDocumentFragment();
          snap.forEach(function(docu){
            var p = docu.data();
            var row = document.createElement('div');
            row.className='row';
            row.style.marginBottom='8px';
            var name = document.createElement('div'); name.textContent = p.name;
            var btnA = document.createElement('button');
            btnA.className='btn btn-outline'; btnA.textContent='Arquivar';
            btnA.onclick = function(){
              db.collection('patients').doc(p.id).set({status:'archived'},{merge:true}).then(function(){
                loadPatientsForSelected();
              });
            };
            row.appendChild(name); row.appendChild(btnA);
            frag.appendChild(row);
          });
          $('patientsBox').innerHTML=''; $('patientsBox').appendChild(frag);
        });
    }

    // --------- ALERTAS (barra + lista) ----------
    function detachBroadcastListeners(){
      if (rootUnsub){ rootUnsub(); rootUnsub = null; }
      if (listUnsub){ listUnsub(); listUnsub = null; }
    }

    function attachBroadcastListeners(){
      detachBroadcastListeners();
      if (!selectedDocId) return;

      var rootRef = db.collection('broadcasts').doc(selectedDocId);
      rootUnsub = rootRef.onSnapshot(function(s){
        var data = s.exists ? s.data() : null;
        renderAlertRoot(data);
      });

      var listRef = db.collection('broadcasts').doc(selectedDocId).collection('alerts')
                      .where('active','==',true).orderBy('createdAt','desc');
      listUnsub = listRef.onSnapshot(function(snap){
        var items = [];
        snap.forEach(function(d){ items.push(d.data()); });
        renderAlertList(null, items); // o filtro anti-duplicação é feito dentro do render
      });
    }

    function renderAlertRoot(data){
      var root = $('alert-root');
      var text = $('alert-root-text');
      if (data && data.active){
        root.style.display='block';
        var pn = data.patientName || '';
        var msg = (data.message||'').toUpperCase();
        var who = (data.emittedByName || 'Médico') + ' (' + (selectedDocId||'') + ')';

        // duas linhas: cabeçalho + destaque do termo (COL/AVAL/OT)
        text.innerHTML = ''
          + '<div class="small"><span class="strong">ALERTA DE:</span> ' + escapeHtml(who) + '</div>'
          + '<div class="strong" style="font-size:18px;margin-top:2px;">'
          + (pn ? '<span class="strong">' + escapeHtml(pn) + '</span>' : '')
          + (pn ? ' – ' : '')
          + escapeHtml(msg)
          + '</div>';

        $('btnDeactivate').onclick = function(){ deactivateAlert(data); };
        $('btnDeactivate').disabled = false;
      } else {
        root.style.display='none';
        $('btnDeactivate').onclick = null;
      }
    }

    function renderAlertList(currentRoot, items){
      // filtra duplicados em relação ao root atual (mesmo message + patientName)
      var rootText = $('alert-root-text').innerText || '';
      var sigRoot = signatureFromRootText(rootText); // "MESSAGE|PATIENT"
      var box = $('alert-list');
      box.innerHTML='';

      for (var i=0;i<items.length;i++){
        var it = items[i];
        var sig = (it.message||'').toUpperCase() + '|' + (it.patientName||'').toUpperCase();
        if (sigRoot && sig === sigRoot) continue; // evita duplicar o mesmo da barra

        var div = document.createElement('div');
        div.className='alert-card';
        // Formato solicitado:
        // <Dr. Nome:>
        // Paciente Nome: COL | AVAL | OT
        var line1 = '<span class="strong">&lt;' + escapeHtml((it.emittedByName||'Médico').toLowerCase()) + ':&gt;</span>';
        var line2 = 'Paciente <span class="strong">' + escapeHtml(it.patientName||'') + '</span>: '
                  + '<span class="strong">' + escapeHtml((it.message||'').toUpperCase()) + '</span>';

        div.innerHTML = line1 + '<br/>' + line2;
        box.appendChild(div);
      }
    }

    function signatureFromRootText(txt){
      // tenta extrair MESSAGE | PATIENT do root (simples e robusto)
      if (!txt) return '';
      // o root imprime:  "ALERTA DE: X\nPACIENTE – MESSAGE"
      var up = txt.toUpperCase();
      // pega última palavra das duas linhas (não é perfeito, mas resolve)
      // Melhor: armazenar globalmente o último root lido
      return window.__lastRootSig || '';
    }

    function deactivateAlert(rootData){
      if (!selectedDocId) return;
      $('btnDeactivate').disabled = true;

      var rootRef = db.collection('broadcasts').doc(selectedDocId);
      rootRef.set({ active:false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true})
        .then(function(){
          // varrer itens que correspondam a este root (mesmo patientName + message)
          var q = db.collection('broadcasts').doc(selectedDocId).collection('alerts')
            .where('active','==',true)
            .where('patientName','==', rootData.patientName || '')
            .where('message','==', (rootData.message||'').toUpperCase());
          return q.get().then(function(snap){
            var batch = db.batch();
            snap.forEach(function(docu){
              batch.update(docu.ref, {active:false, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
            });
            return batch.commit();
          });
        })
        .catch(function(e){ console.error(e); })
        .then(function(){ $('btnDeactivate').disabled = false; });
    }

    function escapeHtml(s){
      if (s==null) return '';
      return String(s).replace(/[&<>"']/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
      });
    }
  })();
  </script>
</body>
</html>
