<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>EyeNote – Uploader Legacy (iPad antigo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; background:#f7fafc; color:#111827; }
    .container { max-width: 960px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 16px 0 8px; }
    .card { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.1); border-top: 4px solid #8b5cf6; }
    .hidden { display:none; }

    /* barra de avisos (lista) */
    .alerts-wrap { margin: 12px 0; }
    .alert-item {
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
      animation: blink 1.2s steps(2, start) infinite;
    }
    @keyframes blink { to { visibility: hidden; } }

    .alert-title { font-weight:700; margin-bottom: 4px; }
    .alert-line { font-size: 14px; }
    .alert-line b { font-weight:700; }
    .alert-actions { margin-top: 6px; }
    .alert-btn {
      background: #ef4444; color:#fff; border:none; border-radius:6px; padding:6px 10px; font-size: 12px; cursor:pointer;
    }

    /* controles simples */
    .row { display:flex; gap:8px; flex-wrap: wrap; align-items: center; }
    .input { border:1px solid #d1d5db; border-radius:6px; padding:6px 8px; font-size:14px; }
    .btn { background:#10b981; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; }
    .btn-secondary { background:#6b7280; }
    .chip { background:#f3f4f6; border-radius: 9999px; padding: 4px 10px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>EyeNote – Uploader Legacy (iPad antigo)</h1>

    <!-- BARRA DE AVISOS (lista empilhada) -->
    <div id="alerts" class="alerts-wrap"></div>

    <!-- (resto da sua página legacy: médicos, pacientes, uploads, etc.) -->
    <div class="card" style="margin-top:12px;">
      <div class="row" style="justify-content: space-between;">
        <div><span class="chip">Legacy conectado</span></div>
        <div id="selectedDocInfo" class="chip hidden"></div>
      </div>

      <!-- Seletor de médico/documento -->
      <div style="margin-top:10px;">
        <div class="row">
          <input id="docIdInput" class="input" style="width:260px" placeholder="ID do documento do médico" />
          <input id="docNameInput" class="input" style="width:220px" placeholder="Nome do médico (ex.: Dr. Fernando)" />
          <button id="addDocBtn" class="btn">Adicionar</button>
          <button id="clearSelectionBtn" class="btn btn-secondary">Limpar seleção</button>
        </div>
        <div id="docsList" class="row" style="margin-top:10px;"></div>
      </div>

      <!-- Paciente + uploads -->
      <div style="margin-top:12px;">
        <div class="row">
          <input id="patientName" class="input" style="flex:1;min-width:220px" placeholder="Nome do paciente" />
          <span id="currentDoc" class="chip hidden"></span>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <div style="font-size:12px;margin-bottom:4px;">Autorrefrator (AR)</div>
            <input id="arFile" type="file" accept="image/*" />
          </div>
          <div>
            <div style="font-size:12px;margin-bottom:4px;">Tonometria (OT)</div>
            <input id="tonoFile" type="file" accept="image/*" />
          </div>
          <button id="uploadBtn" class="btn">Enviar exames</button>
        </div>
      </div>

      <!-- Lista de pacientes por médico (para arquivar/refazer) -->
      <div style="margin-top:14px;">
        <div class="row">
          <button id="refreshPatients" class="btn btn-secondary">Atualizar pacientes</button>
        </div>
        <div id="patientsList" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Firebase compat + Firestore compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    (function(){
      var cfgEl = null;

      function loadConfig(cb) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/firebase-config.json', true);
        xhr.onreadystatechange = function(){
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              try {
                var cfg = JSON.parse(xhr.responseText);
                cb(null, cfg);
              } catch (e) { cb(e); }
            } else {
              cb(new Error('Erro ao carregar firebase-config.json'));
            }
          }
        };
        xhr.send();
      }

      function $(id){ return document.getElementById(id); }
      function el(tag, attrs, children){
        var e = document.createElement(tag);
        if (attrs) for (var k in attrs) {
          if (k === 'className') e.className = attrs[k];
          else if (k === 'text') e.textContent = attrs[k];
          else e.setAttribute(k, attrs[k]);
        }
        if (children && children.length) children.forEach(function(c){ e.appendChild(c); });
        return e;
      }

      var app, db, storage;
      var selectedDoc = null;
      var alertsUnsub = null;

      function renderDocsList() {
        var wrap = $('docsList');
        wrap.innerHTML = '';
        var raw = localStorage.getItem('legacy_docs') || '[]';
        var docs = [];
        try { docs = JSON.parse(raw); } catch(e){ docs = []; }

        docs.forEach(function(d){
          var btn = el('button', { className:'btn btn-secondary', text: d.name || d.id });
          if (selectedDoc && selectedDoc.id === d.id) {
            btn.style.background = '#2563eb'; // azul
          }
          btn.onclick = function(){
            selectedDoc = d;
            localStorage.setItem('legacy_selected_doc', JSON.stringify(selectedDoc));
            $('currentDoc').classList.remove('hidden');
            $('currentDoc').textContent = 'Selecionado: ' + (d.name || d.id);
            subscribeAlerts(); // reata os avisos
            renderDocsList();
          };
          wrap.appendChild(btn);
        });
      }

      function addDoc() {
        var id = $('docIdInput').value.trim();
        var name = $('docNameInput').value.trim();
        if (!id) { alert('Informe o ID do documento do médico'); return; }

        var raw = localStorage.getItem('legacy_docs') || '[]';
        var docs = [];
        try { docs = JSON.parse(raw); } catch(e){}
        if (!docs.some(function(x){ return x.id === id; })) {
          docs.push({ id:id, name:name });
          localStorage.setItem('legacy_docs', JSON.stringify(docs));
        }
        $('docIdInput').value = '';
        $('docNameInput').value = '';
        renderDocsList();
      }

      function clearSelection() {
        selectedDoc = null;
        localStorage.removeItem('legacy_selected_doc');
        $('currentDoc').classList.add('hidden');
        $('currentDoc').textContent = '';
        if (alertsUnsub) { alertsUnsub(); alertsUnsub = null; }
        $('alerts').innerHTML = '';
      }

      // --- AVISOS: listar vários ativos (subcoleção) ---
      function subscribeAlerts(){
        if (alertsUnsub) { alertsUnsub(); alertsUnsub = null; }
        $('alerts').innerHTML = '';

        if (!selectedDoc) return;

        var ref = db.collection('broadcasts').doc(selectedDoc.id).collection('alerts')
          .where('active', '==', true)
          .orderBy('createdAt', 'desc');

        alertsUnsub = ref.onSnapshot(function(snap){
          var container = $('alerts');
          container.innerHTML = '';
          if (snap.empty) return;

          snap.forEach(function(docSnap){
            var a = docSnap.data();
            var title = (a.emittedByName || 'Médico');
            var pName = (a.patientName || 'Paciente');
            var msg = (a.message || '');

            var top = el('div', { className:'alert-title', text: '<' + title + ':>' });
            // Safari iOS 10 não suporta innerText com <> escapados no mesmo estilo, então usamos textContent acima e criamos as 2 linhas separadas:
            top.textContent = '<' + title + ':>';

            var line = el('div', { className:'alert-line' });
            var strongPatient = el('b', { text: 'Paciente ' + pName });
            var sep = document.createTextNode(': ');
            var strongMsg = el('b', { text: msg });

            line.appendChild(strongPatient);
            line.appendChild(sep);
            line.appendChild(strongMsg);

            var actions = el('div', { className:'alert-actions' }, [
              (function(){
                var b = el('button', { className:'alert-btn', text:'Desativar' });
                b.onclick = function(){
                  docSnap.ref.set({ active:false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
                };
                return b;
              })()
            ]);

            var item = el('div', { className:'alert-item' }, [ top, line, actions ]);
            container.appendChild(item);
          });
        }, function(err){
          console.log('Erro no listener de alerts:', err);
        });
      }

      function boot(){
        // carrega config
        loadConfig(function(err, cfg){
          if (err) { console.log(err); alert('Erro ao carregar firebase-config.json'); return; }
          app = firebase.initializeApp(cfg);
          db = firebase.firestore();
          storage = firebase.storage();

          // auth anônima
          firebase.auth().signInAnonymously().catch(function(e){ console.log('auth anon error', e); });

          // restaura docs salvos
          renderDocsList();
          var selectedRaw = localStorage.getItem('legacy_selected_doc');
          if (selectedRaw) {
            try {
              selectedDoc = JSON.parse(selectedRaw);
              if (selectedDoc) {
                $('currentDoc').classList.remove('hidden');
                $('currentDoc').textContent = 'Selecionado: ' + (selectedDoc.name || selectedDoc.id);
                subscribeAlerts();
              }
            } catch(e){}
          }

          $('addDocBtn').onclick = addDoc;
          $('clearSelectionBtn').onclick = clearSelection;

          // (resto: pacientes / uploads — permanece como você já tinha)
          // você mantém aqui o mesmo código que já estava funcionando para criar paciente,
          // fazer upload nos paths corretos e listar/arquivar pacientes por médico.
        });
      }

      document.addEventListener('DOMContentLoaded', boot);
    })();
  </script>
</body>
</html>
